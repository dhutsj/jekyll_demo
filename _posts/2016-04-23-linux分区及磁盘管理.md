#  这篇博客主要想给大家介绍linux的分区以及磁盘管理方面的知识，希望对大家在学习和工作中有所帮助。内容将结合一些理论知识和本人在实际工作中遇到的各种场景。#

  
# **1. linux的目录结构和分区** #
对于linux的目录结构，我想用过linux的人肯定知道，采用树形的目录结构。最上层的根目录，然后一级目录，下来二级目录。如下图1所示这样
![](http://i.imgur.com/UgDSqPz.jpg)
图1  

那么大家是否会好奇各个目录下的数据都放在哪里呢?答案就是根据分区表来放置数据的。好，到这里我们引入了今天的第一个概念，分区表。其实，讲分区表就必须要讲分区。我先告诉大家分区表是什么，`/etc/fstab`就是分区表。下图2所示的是我的主机的分区表
![](http://i.imgur.com/57SagTc.jpg)
图2  

可以看到我这里只有两个分区，一个是根目录所在的`/dev/sda1`,另一个就是我的家目录`/home/tian`所在的/dev/sdb1。我是个超级大懒人嘛，所以这也符合我的风格。那这是什么意思呢？它的意思就是/目录的数据全部存放在/dev/sda1这块硬盘上，/home/tian下的数据全部存放在/dev/sdb1这块硬盘上。linux的分区采用反向匹配的原则，也就是说，从子级目录往回匹配，什么意思？举个例子，比如我往/home/tian里创建一个文件，/home/tian肯定属于/目录，对吧？任何的目录都属于/目录，那这个文件到底放在了哪个硬盘上呢？答案是/dev/sdb1上，因为反向匹配。它会先找/tian,这个二级目录，发现分区表有一条条目跟它匹配，于是它就写到了/home/tian对应的/dev/sdb1上。而如果我要写到/usr下呢？因为没有单独的条目与之匹配，所以它就匹配到了/，于是就写到了/对应的/dev/sda1上。所以你懂了吧，其实我这个分区表，除了/home/tian下的文件单独有盘，其他所有的数据都放在/对应的/dev/sda1上。 BTW，有个目录很特殊，那就是/usr，用户安装的软件通常在这个目录下，所以强烈建议单独分区，且给大空间。 

好，分区表我想大家懂了。但是什么是分区，我还是没说啊？然后图2中的，/dev/sda1对应/，是什么意思啊？慢慢来，我给大家打个比方，你就懂了。大家的家里一定有抽屉，对不对？抽屉就会有大抽屉和小抽屉，你肯定也见过一个大抽屉里面分隔了几个小抽屉，比如你妻子的抽屉，一个抽屉里化妆品分别放在各个抽屉里。讲到这里聪明的你肯定明白了，对，/目录就是这个大抽屉，而其他在分区表里的条目就好比是各个小抽屉。然后为了知道哪类的化妆品放在哪个抽屉里，就必须取个名字呀，这就是挂载点。/home/tian就是这个挂载点。好了，都明白了，至于图2中的ext3这些文件系统的概念，这篇博客里我就不写了，文件系统就又够我喝好几壶了。  

  
# **2. 创建分区fdisk和parted命令** #
好，分区和分区表，我们都明白了，对吧？那就讲讲实际的东西了，怎么创建分区和将分区写入分区表呢？首先要介绍的第一个命令是fdisk,但是有一点必须记住，fdisk如果不指定type为8e，这个命令只能创建MBR分区格式的分区。呀，这里怎么又出现了一个新的概念叫做MBR，它是个什么鬼？它是一种分区的类型，这里大家只要记住有两类分区类型就可以了，一种就是MBR，另一个就是GPT。两者的有很多的区别，比如支持的主分区和扩展分区的数量等。但是对于大家来说，最重要的区别是MBR最大只支持2TB的硬盘分区，而GPT则理论上没有限制。本人曾经就拿到了一块3TB的硬盘，然后用fdisk去分区了。结果分区下来就只有2T，而且用fdisk -l查看分区情况的时候，也是看不到的。不管是fdisk还是parted创建分区，基本是这样的。1. 扫描出未分区的硬盘。2.创建分区。3.创建文件系统。4.挂载。5.写入/etc/fstab。一图胜千言万语，看接下来的图
![](http://i.imgur.com/wIAHdAN.jpg)
图1.扫描出未分区的盘，最后一行，对吧
![](http://i.imgur.com/8utXsyI.jpg)
图2.创建分区
![](http://i.imgur.com/JYcaxDC.jpg)
图3.创建ext3的文件系统以及挂载等
  
fdisk命令我就介绍到这里，大家可以照抄我图中的命令，稍微百度你就全部都掌握了。接下来讲parted命令，对于你手上大于2TB的盘，就必须用它去处理了。一样，直接看图，截图是我的一个真实工作场景哦，哈哈
![](http://i.imgur.com/TKXjKJw.jpg)  
图1.扫描  

![](http://i.imgur.com/CWWt7we.jpg)  
图2.mklable gpt  
![](http://i.imgur.com/0yEpHse.jpg)  
图3.mount  

所以不管是fdisk还是parted，命令不同，但是步骤是一样的。


# **3. LVM（Logical Volume Manager）** #

我们建好分区之后，会经常遇到这种情况，那就是用着用着，发现磁盘满了。那这种时候怎么办呢？当然你可以不断的加盘，然后分区。但是如果要求是动态扩展呢？也就是不能改变当前的分区，而要扩展目录可容纳的大小？怎么办，用LVM！写到这里，我想起曾经在工作中遇到过一件很“蠢”的事情，呀，怎么能自己说自己蠢呢？有一次，我的同事找到我，说，justin，我的一个目录满了，/usr目录吧，我记得。他把所有的软件都装在下面，自然会满。他说软件不能用了，一直报错说磁盘不够，我df -h一看，的确usage到了99%。那怎么办呢？自然就是要扩喽。那个时候，我还不会LVM，但是又要求动态扩展。我想到的第一反应就是给他块更大的盘，然后重新挂载到/usr不就可以了吗?于是我就很单纯的这么干了，结果自然可想而知，你说是什么结果呢？分区挂载所有的步骤都正确，可是一起来，傻眼了，数据全都丢了。切记，各位，重新挂载会冲掉你所有的数据，也就是/usr下什么都没有了。后来我怎么解决的吗？你可以想想，我卖个关子。反正我最后恢复了他所有的数据，，也帮他扩展了。

正式介绍LVM，网上有很多介绍LVM的，我就不重复了。我个人认为，对于LVM，你只要掌握了PV，VG，LV，还有PE这4个概念就足够了。一个一个介绍，PV（Physical Volume），物理卷，你可以简单的认为它对应了一个硬盘。VG（Volume Group），卷组，要可扩，物理卷必须属于同一个卷组。LV（Logical Volume），逻辑卷，你可以对应一个目录。PE（Physical Extent），当多个物理卷组合成一个卷组后时，LVM会在所有的物理卷上做类似格式化的工作，将每个物理卷切成一块一块的空间，这一块一块的空间就称为PE（Physical Extent ），它的默认大小是4MB。由于受内核限制的原因，一个逻辑卷（Logic Volume）最多只能包含65536个PE（Physical Extent），所以一个PE的大小就决定了逻辑卷的最大容量，4 MB 的PE决定了单个逻辑卷最大容量为 256 GB，若希望使用大于256G的逻辑卷，则创建卷组时需要指定更大的PE。我个人建议设成128MB，这样一般就足够了。OK，来看图，也就是命令啦和过程，我把所有的步骤都放在图里了，你看出来了吗？  

1. 	 fdisk -c /dev/sda，指定type为8e，这是LVM的类型
![](http://i.imgur.com/gy2MIc4.png)
2. 	Creating Physical Volumes，	pvcreate /dev/sda1
![](http://i.imgur.com/LSjsdDe.png)
3.  Creating Volume Groups，	vgcreate -s 128M my_first_vg /dev/sda1
![](http://i.imgur.com/mQuNJiH.png)
4. 	Creating Logical Volumes， 	lvcreate -l 79 -n test my_first_vg
![](http://i.imgur.com/jR0NA4X.png)
5.  Creating File System,	mkfs.ext3 /dev/my_first_vg/test
6.  Mount, mount /dev/my_first_vg/test /mnt/test/
7.  vim /etc/fstab,上两步的图我就不放了，和之前的一样，让我们看看最后的结果
![](http://i.imgur.com/8Sh7fqe.png)

到这里，只是建好了PV，VG和LV，接下来的步骤是去扩展之前建的LV  

1. 分区新的硬盘，	 fdisk -c /dev/sdd  
2. 用这块盘创建一个新的PV，	pvcreate /dev/sdd1  
3. 利用这个PV扩展VG，	vgextend my_first_vg /dev/sdd1  
![](http://i.imgur.com/ghVhNdX.png)
![](http://i.imgur.com/zcPVl8k.png)
4. 前面创建的LV属于这个VG，所以就可以扩展了，	 lvextend -l +79 /dev/my_first_vg/test
5. 	resize2fs /dev/my_first_vg/tests
6.  df -h验证
![](http://i.imgur.com/QfJBNpW.png)

至此，我对于linux的分区以及磁盘管理就介绍完了。以上的内容肯定有一些不足之处，希望大家指正。这是我的个人邮箱，大家如果有任何意见，给我发邮件。dhutsj@gmail.com。然后我有以上所有内容的word版本，那个更详细一些，想要的也可以给我发邮件，欢迎大家一起交流。最后谢谢大家看我的博客！







